(function(M,w){typeof exports=="object"&&typeof module!="undefined"?w(require("leaflet")):typeof define=="function"&&define.amd?define(["leaflet"],w):(M=typeof globalThis!="undefined"?globalThis:M||self,w(M.L))})(this,function(M){"use strict";var Q=(M,w,T)=>new Promise((x,O)=>{var A=S=>{try{E(T.next(S))}catch(b){O(b)}},I=S=>{try{E(T.throw(S))}catch(b){O(b)}},E=S=>S.done?x(S.value):Promise.resolve(S.value).then(A,I);E((T=T.apply(M,w)).next())});var w=63710088e-1,T={centimeters:w*100,centimetres:w*100,degrees:w/111325,feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function x(t,i,e){e===void 0&&(e={});var r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=i||{},r.geometry=t,r}function O(t,i,e){if(e===void 0&&(e={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!H(t[0])||!H(t[1]))throw new Error("coordinates must contain numbers");var r={type:"Point",coordinates:t};return x(r,i,e)}function A(t,i,e){if(e===void 0&&(e={}),t.length<2)throw new Error("coordinates must be an array of two or more positions");var r={type:"LineString",coordinates:t};return x(r,i,e)}function I(t,i){i===void 0&&(i="kilometers");var e=T[i];if(!e)throw new Error(i+" units is invalid");return t*e}function E(t,i){i===void 0&&(i="kilometers");var e=T[i];if(!e)throw new Error(i+" units is invalid");return t/e}function S(t){var i=t%(2*Math.PI);return i*180/Math.PI}function b(t){var i=t%360;return i*Math.PI/180}function H(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function X(t){return!!t&&t.constructor===Object}function N(t,i,e){if(t!==null)for(var r,n,h,d,p,c,g,v=0,f=0,P,o=t.type,s=o==="FeatureCollection",a=o==="Feature",l=s?t.features.length:1,u=0;u<l;u++){g=s?t.features[u].geometry:a?t.geometry:t,P=g?g.type==="GeometryCollection":!1,p=P?g.geometries.length:1;for(var y=0;y<p;y++){var m=0,_=0;if(d=P?g.geometries[y]:g,d!==null){c=d.coordinates;var k=d.type;switch(v=0,k){case null:break;case"Point":if(i(c,f,u,m,_)===!1)return!1;f++,m++;break;case"LineString":case"MultiPoint":for(r=0;r<c.length;r++){if(i(c[r],f,u,m,_)===!1)return!1;f++,k==="MultiPoint"&&m++}k==="LineString"&&m++;break;case"Polygon":case"MultiLineString":for(r=0;r<c.length;r++){for(n=0;n<c[r].length-v;n++){if(i(c[r][n],f,u,m,_)===!1)return!1;f++}k==="MultiLineString"&&m++,k==="Polygon"&&_++}k==="Polygon"&&m++;break;case"MultiPolygon":for(r=0;r<c.length;r++){for(_=0,n=0;n<c[r].length;n++){for(h=0;h<c[r][n].length-v;h++){if(i(c[r][n][h],f,u,m,_)===!1)return!1;f++}_++}m++}break;case"GeometryCollection":for(r=0;r<d.geometries.length;r++)if(N(d.geometries[r],i)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Y(t,i){var e,r,n,h,d,p,c,g,v,f,P=0,o=t.type==="FeatureCollection",s=t.type==="Feature",a=o?t.features.length:1;for(e=0;e<a;e++){for(p=o?t.features[e].geometry:s?t.geometry:t,g=o?t.features[e].properties:s?t.properties:{},v=o?t.features[e].bbox:s?t.bbox:void 0,f=o?t.features[e].id:s?t.id:void 0,c=p?p.type==="GeometryCollection":!1,d=c?p.geometries.length:1,n=0;n<d;n++){if(h=c?p.geometries[n]:p,h===null){if(i(null,P,g,v,f)===!1)return!1;continue}switch(h.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(i(h,P,g,v,f)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<h.geometries.length;r++)if(i(h.geometries[r],P,g,v,f)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}P++}}function j(t,i){Y(t,function(e,r,n,h,d){var p=e===null?null:e.type;switch(p){case null:case"Point":case"LineString":case"Polygon":return i(x(e,n,{bbox:h,id:d}),r,0)===!1?!1:void 0}var c;switch(p){case"MultiPoint":c="Point";break;case"MultiLineString":c="LineString";break;case"MultiPolygon":c="Polygon";break}for(var g=0;g<e.coordinates.length;g++){var v=e.coordinates[g],f={type:c,coordinates:v};if(i(x(f,n),r,g)===!1)return!1}})}function $(t,i){j(t,function(e,r,n){var h=0;if(e.geometry){var d=e.geometry.type;if(!(d==="Point"||d==="MultiPoint")){var p,c=0,g=0,v=0;if(N(e,function(f,P,o,s,a){if(p===void 0||r>c||s>g||a>v){p=f,c=r,g=s,v=a,h=0;return}var l=A([p,f],e.properties);if(i(l,r,n,a,h)===!1)return!1;h++,p=f})===!1)return!1}}})}function tt(t,i,e){var r=e,n=!1;return $(t,function(h,d,p,c,g){n===!1&&e===void 0?r=h:r=i(r,h,d,p,c,g),n=!0}),r}function F(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return t.geometry.coordinates;if(t.type==="Point")return t.coordinates}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function et(t){return t.type==="Feature"?t.geometry:t}var it=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function U(t,i,e){e===void 0&&(e={});var r=F(t),n=F(i),h=b(n[1]-r[1]),d=b(n[0]-r[0]),p=b(r[1]),c=b(n[1]),g=Math.pow(Math.sin(h/2),2)+Math.pow(Math.sin(d/2),2)*Math.cos(p)*Math.cos(c);return I(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),e.units)}function B(t,i,e,r){r===void 0&&(r={});var n=F(t),h=b(n[0]),d=b(n[1]),p=b(e),c=E(i,r.units),g=Math.asin(Math.sin(d)*Math.cos(c)+Math.cos(d)*Math.sin(c)*Math.cos(p)),v=h+Math.atan2(Math.sin(p)*Math.sin(c)*Math.cos(d),Math.cos(c)-Math.sin(d)*Math.sin(g)),f=S(v),P=S(g);return O([f,P],r.properties)}function R(t,i,e){if(e===void 0&&(e={}),e.final===!0)return st(t,i);var r=F(t),n=F(i),h=b(r[0]),d=b(n[0]),p=b(r[1]),c=b(n[1]),g=Math.sin(d-h)*Math.cos(c),v=Math.cos(p)*Math.sin(c)-Math.sin(p)*Math.cos(c)*Math.cos(d-h);return S(Math.atan2(g,v))}function st(t,i){var e=R(i,t);return e=(e+180)%360,e}function V(t,i,e){e===void 0&&(e={});for(var r=et(t),n=r.coordinates,h=0,d=0;d<n.length&&!(i>=h&&d===n.length-1);d++)if(h>=i){var p=i-h;if(p){var c=R(n[d],n[d-1])-180,g=B(n[d],p,c,e);return g}else return O(n[d])}else h+=U(n[d],n[d+1],e);return O(n[n.length-1])}function Z(t,i){return i===void 0&&(i={}),tt(t,function(e,r){var n=r.geometry.coordinates;return e+U(n[0],n[1],i)},0)}function J(t,i,e,r){if(r=r||{},!X(r))throw new Error("options is invalid");var n,h=[];if(t.type==="Feature")n=t.geometry.coordinates;else if(t.type==="LineString")n=t.coordinates;else throw new Error("input must be a LineString Feature or Geometry");for(var d=n.length,p=0,c,g,v,f=0;f<n.length&&!(i>=p&&f===n.length-1);f++){if(p>i&&h.length===0){if(c=i-p,!c)return h.push(n[f]),A(h);g=R(n[f],n[f-1])-180,v=B(n[f],c,g,r),h.push(v.geometry.coordinates)}if(p>=e)return c=e-p,c?(g=R(n[f],n[f-1])-180,v=B(n[f],c,g,r),h.push(v.geometry.coordinates),A(h)):(h.push(n[f]),A(h));if(p>=i&&h.push(n[f]),f===n.length-1)return A(h);p+=U(n[f],n[f+1],r)}if(p<i&&n.length===d)throw new Error("Start position is beyond line");var P=n[n.length-1];return A([P,P])}(function(t,i){(function(e,r){r(M)})(it,function(e){e=e&&e.hasOwnProperty("default")?e.default:e;function r(o,s){var a=s.x-o.x,l=s.y-o.y;return Math.sqrt(a*a+l*l)}var n=function(s,a){return(Math.atan2(a.y-s.y,a.x-s.x)*180/Math.PI+90+360)%360},h=function(s,a){var l=s.value,u=s.isInPixels;return u?l/a:l};function d(o){if(typeof o=="string"&&o.indexOf("%")!==-1)return{value:parseFloat(o)/100,isInPixels:!1};var s=o?parseFloat(o):0;return{value:s,isInPixels:s>0}}var p=function(s,a){return s.x===a.x&&s.y===a.y};function c(o){return o.reduce(function(s,a,l,u){if(l>0&&!p(a,u[l-1])){var y=u[l-1],m=s.length>0?s[s.length-1].distB:0,_=r(y,a);s.push({a:y,b:a,distA:m,distB:m+_,heading:n(y,a)})}return s},[])}function g(o,s){var a=c(o),l=a.length;if(l===0)return[];var u=a[l-1].distB,y=h(s.offset,u),m=h(s.endOffset,u),_=h(s.repeat,u),k=u*_,C=y>0?u*y:0,z=m>0?u*m:0,G=[],W=C;do G.push(W),W+=k;while(k>0&&W<u-z);var q=0,D=a[0];return G.map(function(K){for(;K>D.distB&&q<l-1;)q++,D=a[q];var rt=(K-D.distA)/(D.distB-D.distA);return{pt:v(D.a,D.b,rt),heading:D.heading}})}function v(o,s,a){return s.x!==o.x?{x:o.x+a*(s.x-o.x),y:o.y+a*(s.y-o.y)}:{x:o.x,y:o.y+(s.y-o.y)*a}}(function(){var o=L.Marker.prototype._initIcon,s=L.Marker.prototype._setPos,a=L.DomUtil.TRANSFORM==="msTransform";L.Marker.addInitHook(function(){var l=this.options.icon&&this.options.icon.options,u=l&&this.options.icon.options.iconAnchor;u&&(u=u[0]+"px "+u[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||u||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(y){y.target._applyRotation()})}),L.Marker.include({_initIcon:function(){o.call(this)},_setPos:function(l){s.call(this,l),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,a?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(l){return this.options.rotationAngle=l,this.update(),this},setRotationOrigin:function(l){return this.options.rotationOrigin=l,this.update(),this}})})(),e.Symbol=e.Symbol||{},e.Symbol.Dash=e.Class.extend({options:{pixelSize:10,pathOptions:{}},initialize:function(s){e.Util.setOptions(this,s),this.options.pathOptions.clickable=!1},buildSymbol:function(s,a,l,u,y){var m=this.options,_=Math.PI/180;if(m.pixelSize<=1)return e.polyline([s.latLng,s.latLng],m.pathOptions);var k=l.project(s.latLng),C=-(s.heading-90)*_,z=e.point(k.x+m.pixelSize*Math.cos(C+Math.PI)/2,k.y+m.pixelSize*Math.sin(C)/2),G=k.add(k.subtract(z));return e.polyline([l.unproject(z),l.unproject(G)],m.pathOptions)}}),e.Symbol.dash=function(o){return new e.Symbol.Dash(o)},e.Symbol.ArrowHead=e.Class.extend({options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(s){e.Util.setOptions(this,s),this.options.pathOptions.clickable=!1},buildSymbol:function(s,a,l,u,y){return this.options.polygon?e.polygon(this._buildArrowPath(s,l),this.options.pathOptions):e.polyline(this._buildArrowPath(s,l),this.options.pathOptions)},_buildArrowPath:function(s,a){var l=Math.PI/180,u=a.project(s.latLng),y=-(s.heading-90)*l,m=this.options.headAngle/2*l,_=y+m,k=y-m,C=e.point(u.x-this.options.pixelSize*Math.cos(_),u.y+this.options.pixelSize*Math.sin(_)),z=e.point(u.x-this.options.pixelSize*Math.cos(k),u.y+this.options.pixelSize*Math.sin(k));return[a.unproject(C),s.latLng,a.unproject(z)]}}),e.Symbol.arrowHead=function(o){return new e.Symbol.ArrowHead(o)},e.Symbol.Marker=e.Class.extend({options:{markerOptions:{},rotate:!1},initialize:function(s){e.Util.setOptions(this,s),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1},buildSymbol:function(s,a,l,u,y){return this.options.rotate&&(this.options.markerOptions.rotationAngle=s.heading+(this.options.angleCorrection||0)),e.marker(s.latLng,this.options.markerOptions)}}),e.Symbol.marker=function(o){return new e.Symbol.Marker(o)};var f=function(s){return s instanceof e.LatLng||Array.isArray(s)&&s.length===2&&typeof s[0]=="number"},P=function(s){return Array.isArray(s)&&f(s[0])};e.PolylineDecorator=e.FeatureGroup.extend({options:{patterns:[]},initialize:function(s,a){e.FeatureGroup.prototype.initialize.call(this),e.Util.setOptions(this,a),this._map=null,this._paths=this._initPaths(s),this._bounds=this._initBounds(),this._patterns=this._initPatterns(this.options.patterns)},_initPaths:function(s,a){var l=this;if(P(s)){var u=a?s.concat([s[0]]):s;return[u]}return s instanceof e.Polyline?this._initPaths(s.getLatLngs(),s instanceof e.Polygon):Array.isArray(s)?s.reduce(function(y,m){return y.concat(l._initPaths(m,a))},[]):[]},_initPatterns:function(s){return s.map(this._parsePatternDef)},setPatterns:function(s){this.options.patterns=s,this._patterns=this._initPatterns(this.options.patterns),this.redraw()},setPaths:function(s){this._paths=this._initPaths(s),this._bounds=this._initBounds(),this.redraw()},_parsePatternDef:function(s,a){return{symbolFactory:s.symbol,offset:d(s.offset),endOffset:d(s.endOffset),repeat:d(s.repeat)}},onAdd:function(s){this._map=s,this._draw(),this._map.on("moveend",this.redraw,this)},onRemove:function(s){this._map.off("moveend",this.redraw,this),this._map=null,e.FeatureGroup.prototype.onRemove.call(this,s)},_initBounds:function(){var s=this._paths.reduce(function(a,l){return a.concat(l)},[]);return e.latLngBounds(s)},getBounds:function(){return this._bounds},_buildSymbols:function(s,a,l){var u=this;return l.map(function(y,m){return a.buildSymbol(y,s,u._map,m,l.length)})},_getDirectionPoints:function(s,a){var l=this;if(s.length<2)return[];var u=s.map(function(y){return l._map.project(y)});return g(u,a).map(function(y){return{latLng:l._map.unproject(e.point(y.pt)),heading:y.heading}})},redraw:function(){this._map&&(this.clearLayers(),this._draw())},_getPatternLayers:function(s){var a=this,l=this._map.getBounds().pad(.1);return this._paths.map(function(u){var y=a._getDirectionPoints(u,s).filter(function(m){return l.contains(m.latLng)});return e.featureGroup(a._buildSymbols(u,s.symbolFactory,y))})},_draw:function(){var s=this;this._patterns.map(function(a){return s._getPatternLayers(a)}).forEach(function(a){s.addLayer(e.featureGroup(a))})}}),e.polylineDecorator=function(o,s){return new e.PolylineDecorator(o,s)}})})(),function(){var t=L.Marker.prototype._initIcon,i=L.Marker.prototype._setPos,e=L.DomUtil.TRANSFORM==="msTransform";L.Marker.addInitHook(function(){var r=this.options.icon&&this.options.icon.options,n=r&&this.options.icon.options.iconAnchor;n&&(n=n[0]+"px "+n[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||n||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(h){h.target._applyRotation()})}),L.Marker.include({_initIcon:function(){t.call(this)},_setPos:function(r){i.call(this,r),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,e?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(r){return this.options.rotationAngle=r,this.update(),this},setRotationOrigin:function(r){return this.options.rotationOrigin=r,this.update(),this}})}(),M.TrackPlayer=class{constructor(t,i={}){this._initializeTrack(t),this.options=this._mergeOptions(i),this.initProgress=i.progress,this.addedToMap=!1,this.isPaused=!0,this.finished=!1,this.walkedDistance=0,this.walkedDistanceTemp=0,this.trackIndex=0,this.startTimestamp=0,this.pauseTimestamp=0,this.events={start:[],pause:[],finished:[],progress:[]}}_initializeTrack(t){const i=M.polyline(t)._latlngs;this.track=A(i.map(({lng:e,lat:r})=>[e,r])),this.distanceSlice=this._calculateDistanceSlices(),this.distance=Z(this.track)}_calculateDistanceSlices(){const t=[0],i=this.track.geometry.coordinates;for(let e=1;e<i.length;e++){const r=A(i.slice(0,e+1));t.push(Z(r))}return t}_mergeOptions(t){var i,e,r,n,h,d,p,c,g,v,f,P,o,s,a,l,u,y,m,_;return{speed:(i=t.speed)!=null?i:600,weight:(e=t.weight)!=null?e:5,passedLineWeight:(n=t.passedLineWeight)!=null?n:((r=t.weight)!=null?r:5)+1,notPassedLineWeight:(d=(h=t.notPassedLineWeight)!=null?h:t.weight)!=null?d:5,markerIcon:t.markerIcon,showArrows:(p=t.showArrows)!=null?p:!0,arrowColor:(c=t.arrowColor)!=null?c:"#fff",arrowSize:(g=t.arrowSize)!=null?g:5,arrowOpacity:(v=t.arrowOpacity)!=null?v:1,polylineDecoratorOptions:(f=t.polylineDecoratorOptions)!=null?f:this._getDefaultDecoratorOptions(t),passedLineColor:(P=t.passedLineColor)!=null?P:"#0000ff",notPassedLineColor:(o=t.notPassedLineColor)!=null?o:"#ff0000",passedLineOpacity:(s=t.passedLineOpacity)!=null?s:1,notPassedLineOpacity:(a=t.notPassedLineOpacity)!=null?a:1,panTo:(l=t.panTo)!=null?l:!0,markerRotationOrigin:(u=t.markerRotationOrigin)!=null?u:"center",markerRotationOffset:(y=t.markerRotationOffset)!=null?y:0,markerRotation:(m=t.markerRotation)!=null?m:!0,progress:(_=t.progress)!=null?_:0}}_getDefaultDecoratorOptions(t={}){var r,n,h;const i=(r=t.arrowSize)!=null?r:5,e=Math.max(1,Math.min(3,Math.ceil(i/3)));return{patterns:[{offset:30,repeat:60,symbol:M.Symbol.arrowHead({pixelSize:i,headAngle:60,polygon:!1,pathOptions:{stroke:!0,weight:e,color:(n=t.arrowColor)!=null?n:"#fff",opacity:(h=t.arrowOpacity)!=null?h:1}})}]}}addTo(t){return this.addedToMap?this:(this.map=t,this.addedToMap=!0,this._createMarker(),this._createLines(),this._createDecorator(),this.initProgress&&this.setProgress(this.initProgress),this)}_createMarker(){if(!this.options.markerIcon)return;const[t,i]=this.track.geometry.coordinates[0];this.marker=M.marker([i,t],{icon:this.options.markerIcon}).addTo(this.map),this.options.markerRotation&&this._setInitialMarkerRotation()}_setInitialMarkerRotation(){const t=this.track.geometry.coordinates,i=R(t[0],t[1]);this.marker.setRotationAngle(i/2+this.options.markerRotationOffset/2),this.marker.setRotationOrigin(this.options.markerRotationOrigin)}_createLines(){const t=this.track.geometry.coordinates.map(([i,e])=>[e,i]);this.notPassedLine=M.polyline(t,{weight:this.options.notPassedLineWeight,color:this.options.notPassedLineColor,opacity:this.options.notPassedLineOpacity}).addTo(this.map),this.passedLine=M.polyline([],{weight:this.options.passedLineWeight,color:this.options.passedLineColor,opacity:this.options.passedLineOpacity}).addTo(this.map)}_createDecorator(){if(!this.options.showArrows)return;const t=this.track.geometry.coordinates.map(([i,e])=>[e,i]);this.polylineDecorator=M.polylineDecorator(t,this.options.polylineDecoratorOptions).addTo(this.map)}remove(){return this.addedToMap?(this.addedToMap=!1,this._cleanup(),this._resetState(),this):this}_cleanup(){var t,i,e,r;(t=this.polylineDecorator)==null||t.remove(),(i=this.notPassedLine)==null||i.remove(),(e=this.passedLine)==null||e.remove(),(r=this.marker)==null||r.remove(),this.polylineDecorator=null,this.notPassedLine=null,this.passedLine=null,this.marker=null}_resetState(){this.finished=!1,this.startTimestamp=0,this.pauseTimestamp=0,this.walkedDistanceTemp=0,this.walkedDistance=0,this.trackIndex=0,this.isPaused=!0,this.options.progress=this.initProgress}start(){return!this.isPaused&&!this.finished||!this.addedToMap?this:(this._prepareStart(),this.isPaused=!1,this.finished=!1,this._adjustTimestamp(),this._startAnimation(),this._emit("start"),this.initProgress&&this.setProgress(this.initProgress),this)}_prepareStart(){(this.options.progress===0||this.options.progress===1)&&(this.startTimestamp=0,this.pauseTimestamp=0,this.walkedDistanceTemp=0,this.walkedDistance=0)}_adjustTimestamp(){this.pauseTimestamp&&this.startTimestamp&&(this.startTimestamp+=Date.now()-this.pauseTimestamp)}pause(){return this.isPaused||this.finished?this:(this.pauseTimestamp=Date.now(),this.isPaused=!0,this._emit("pause"),this)}_startAnimation(){const t=this.distance,i=t/this.options.speed*3600*1e3,e=r=>{if(r&&this.addedToMap){this.startTimestamp||(this.startTimestamp=r);const n=r-this.startTimestamp;this.walkedDistance=Math.min(t,t*n/i+this.walkedDistanceTemp),this._updatePosition()}!this.isPaused&&!this.finished&&requestAnimationFrame(e)};requestAnimationFrame(e)}_updatePosition(t=!1){this.isPaused&&!t||(this.distance,this._updateTrackIndex(),this._updateMarkerPosition(),this._updateLines(),this._updateDecorator(),this._updateMarkerRotation(),this._updateProgress(),this._checkCompletion())}_updateTrackIndex(){this.trackIndex=this.distanceSlice.findIndex((t,i,e)=>{var r;return this.walkedDistance>=t&&this.walkedDistance<((r=e[i+1])!=null?r:1/0)})}_updateMarkerPosition(){var e;const[t,i]=V(this.track,this.walkedDistance).geometry.coordinates;this.markerPoint=[i,t],this.options.panTo&&this.map.panTo(this.markerPoint,{animate:!1}),(e=this.marker)==null||e.setLatLng(this.markerPoint)}_updateLines(){const t=this.distance;if(this.walkedDistance>=t)this.notPassedLine.setLatLngs([]);else{const i=J(this.track,this.walkedDistance);this.notPassedLine.setLatLngs(i.geometry.coordinates.map(([e,r])=>[r,e]))}if(this.walkedDistance>0){const i=J(this.track,0,this.walkedDistance);this.passedLine.setLatLngs(i.geometry.coordinates.map(([e,r])=>[r,e]))}else this.passedLine.setLatLngs([])}_updateDecorator(){!this.options.showArrows||!this.polylineDecorator||this.polylineDecorator.setPaths([...this.passedLine.getLatLngs(),...this.notPassedLine.getLatLngs()])}_updateMarkerRotation(){if(!this.options.markerRotation||!this.marker||this.walkedDistance>=this.distance)return;const t=this.trackIndex+1;if(t<this.track.geometry.coordinates.length){const i=V(this.track,this.walkedDistance).geometry.coordinates,e=this.track.geometry.coordinates[t],r=R(O(i),O(e));this.marker.setRotationAngle(r/2+this.options.markerRotationOffset/2)}}_updateProgress(){this.options.progress=Math.min(1,this.walkedDistance/this.distance),this._emit("progress",this.options.progress,M.latLng(...this.markerPoint),this.trackIndex)}_checkCompletion(){this.walkedDistance>=this.distance&&(this.walkedDistance=this.distance,this.finished=!0,this._setFinalMarkerRotation(),this._emit("finished"))}_setFinalMarkerRotation(){if(!this.options.markerRotation||!this.marker)return;const t=this.track.geometry.coordinates,i=R(O(t.at(-2)),O(t.at(-1)));this.marker.setRotationAngle(i/2+this.options.markerRotationOffset/2)}_setSpeedAction(t){this.options.speed=t,this.walkedDistanceTemp=this.walkedDistance,this.startTimestamp=0}setSpeed(t,i=20){return Q(this,null,function*(){return i&&(clearTimeout(this.setSpeedTimeout),yield new Promise(e=>{this.setSpeedTimeout=setTimeout(e,i)})),this._setSpeedAction(t),this})}setProgress(t){return this.addedToMap?this.options.progress===1&&t===1||this.options.progress===0&&t===0?this:(this.options.progress=t,this.walkedDistanceTemp=this.distance*t,this.startTimestamp=0,(this.isPaused||this.finished)&&(this.walkedDistance=this.walkedDistanceTemp,this.finished?(this.finished=!1,this.isPaused=!1,this._startAnimation()):this._updatePosition(!0)),this):this}on(t,i){return this.events[t]?(this.events[t].push(i),this):(console.warn(`Unknown event: ${t}`),this)}off(t,i){return this.events[t]?(i?this.events[t]=this.events[t].filter(e=>e!==i):this.events[t]=[],this):(console.warn(`Unknown event: ${t}`),this)}_emit(t,...i){this.events[t]&&this.events[t].forEach(e=>e(...i))}updateLineStyle(t={}){if(!this.addedToMap)return this;const{passedLineColor:i,notPassedLineColor:e,passedLineWeight:r,notPassedLineWeight:n,passedLineOpacity:h,notPassedLineOpacity:d}=t;return i!==void 0&&(this.options.passedLineColor=i,this.passedLine.setStyle({color:i})),e!==void 0&&(this.options.notPassedLineColor=e,this.notPassedLine.setStyle({color:e})),r!==void 0&&(this.options.passedLineWeight=r,this.passedLine.setStyle({weight:r})),n!==void 0&&(this.options.notPassedLineWeight=n,this.notPassedLine.setStyle({weight:n})),h!==void 0&&(this.options.passedLineOpacity=h,this.passedLine.setStyle({opacity:h})),d!==void 0&&(this.options.notPassedLineOpacity=d,this.notPassedLine.setStyle({opacity:d})),this}updateArrowStyle(t={}){if(!this.addedToMap)return this;const{color:i,size:e,opacity:r,show:n}=t;return n!==void 0&&(this.options.showArrows=n,n&&!this.polylineDecorator?this._createDecorator():!n&&this.polylineDecorator&&(this.polylineDecorator.remove(),this.polylineDecorator=null)),this.polylineDecorator&&(i!==void 0||e!==void 0||r!==void 0)&&(i!==void 0&&(this.options.arrowColor=i),e!==void 0&&(this.options.arrowSize=e),r!==void 0&&(this.options.arrowOpacity=r),this.polylineDecorator.remove(),this.options.polylineDecoratorOptions=this._getDefaultDecoratorOptions(this.options),this._createDecorator()),this}showArrows(){return this.updateArrowStyle({show:!0})}hideArrows(){return this.updateArrowStyle({show:!1})}getState(){return{progress:this.options.progress,isPaused:this.isPaused,finished:this.finished,speed:this.options.speed,distance:this.distance,walkedDistance:this.walkedDistance,currentPosition:this.markerPoint?M.latLng(...this.markerPoint):null,trackIndex:this.trackIndex}}}});
